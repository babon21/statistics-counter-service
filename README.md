# Микросервис для счетчиков статистики

<!-- ToC start -->
# Обзор

1. [Запуск приложения](#Запуск-приложения)
1. [Запуск линтера](#Запуск-линтера)
1. [Реализация](#Реализация)
1. [Усложнения](#Реализация)
1. [Используемые библиотеки](#Используемые-библиотеки)
1. [API](#API)
<!-- ToC end -->

# Запуск приложения
```
docker-compose up
``` 

# Запуск линтера
Предварительно необходимо установить линтер в локальный репозиторий командой:
```
make lint-prepare
```
Запуск линтера:
```
make lint
```

# Юнит-тесты
Запуск юнит-тестов:
```
make test
```

# Реализация
- Язык программирования Go
- База данных PostgreSQL
- HTTP JSON API
# Усложнения
- Следование принципам подхода "Чистая архитектура"
- Покрытие кода Юнит тестами (покрытие 74% всего кода)
- В методе показа статистики можно выбрать сортировку по любому из полей ответа
- Использование индексов БД (создание в файле init.sql)
- Докеризация приложения и запуск с помощью `docker-compose`
- Многоэтапная сборка Docker-образа сервиса
- Использование переменных окружения для конфигурации приложения (One of The Twelve-Factor App)
- Использование линтера `golangci-lint`
- Логирование HTTP запросов с помощью middleware
- Валидация запросов
# Используемые библиотеки
- Веб-фреймворк `echo`
- Конфигурирование приложения - библиотека `viper`
- `sqlx` для работы с БД
- Генерация mock-объектов для unit-тестирования - `mockery`
- Валидация запросов - `go-playground/validator`
- Логирование с помощью `zerolog`

# API
### POST /statistics
**Сохранение статистики.**
Принимает на вход:

- date - дата события
- views - количество показов
- clicks - количество кликов
- cost - стоимость кликов (в рублях с точностью до копеек)
- Поля views, clicks и cost - опциональные.

```
{
    "date": "2002-03-30",
    "views": 167,
    "clicks": 3875,
    "cost": 32.21
}
```
Возвращает в случае успеха Status 201

Запрос:
```
curl --request POST 'localhost:8080/statistics' \
--header 'Content-Type: application/json' \
--data-raw '{
    "date": "2002-03-30",
    "views": 167,
    "clicks": 3875,
    "cost": 32.21
}'
```

### GET /statistics
**Получение статистики.**
Принимает на вход:

- from - дата начала периода (включительно)
- to - дата окончания периода (включительно)
- Отвечает статистикой, отсортированной по дате. В ответе должны быть поля:


- date - дата события
- views - количество показов
- clicks - количество кликов
- cost - стоимость кликов
- cpc = cost/clicks (средняя стоимость клика)
- cpm = cost/views * 1000 (средняя стоимость 1000 показов)

Можно выбрать сортировку по любому из полей ответа.
#### Пример запроса и ответа
Запрос:
```
curl --request GET 'localhost:8080/statistics' \
--header 'Content-Type: application/json' \
--data-raw '{
    "from": "2002-01-01",
    "to": "2004-03-30",
    "sort_by": "date",
    "order_by": "desc"
}'
```
Ответ:
```
{
    "statistics": [
        {
            "date": "2002-03-30",
            "views": 1,
            "clicks": 3,
            "cost": 10.35,
            "cpc": 3.45,
            "cpm": 10.35
        },
        {
            "date": "2002-03-28",
            "views": 167,
            "clicks": 3875,
            "cost": 106543.35,
            "cpc": 27.5,
            "cpm": 637.99
        }
    ]
}
```

### DELETE /statistics
**Сброс статистики.**
Удаляет всю сохраненную статистику.

#### Пример запроса и ответа
Запрос:
```
curl --request DELETE 'localhost:8080/statistics'
```
Ответ в случае успеха Status 204
